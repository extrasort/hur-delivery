<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>لوحة رسائل الدعم</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
      header { padding: 12px 16px; background: #0f766e; color: white; }
      main { display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 56px); }
      aside { border-left: 1px solid #eee; overflow: auto; }
      section { overflow: auto; display: flex; flex-direction: column; }
      .conv { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
      .conv:hover { background: #fafafa; }
      .msg { margin: 8px 12px; padding: 8px 12px; border-radius: 8px; background: #f7f7f7; }
      .msg.me { background: #e6fffa; align-self: flex-end; }
      .toolbar { padding: 8px; border-top: 1px solid #eee; display: flex; gap: 8px; }
      input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
      button { padding: 8px 12px; border: none; background: #0f766e; color: white; border-radius: 6px; cursor: pointer; }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // Initialize supabase client from environment (replace placeholders)
      const supabaseClient = window.supabase.createClient(
        'https://YOUR_PROJECT.supabase.co',
        'YOUR_PUBLIC_ANON_KEY'
      );
    </script>
    <script src="./app_messaging.js"></script>
  </head>
  <body>
    <header>
      <h3>لوحة رسائل الدعم</h3>
    </header>
    <main>
      <aside id="conversations"></aside>
      <section>
        <div id="messages" style="flex:1; overflow:auto;"></div>
        <div class="toolbar">
          <input type="text" id="compose" placeholder="اكتب رسالة..." />
          <button id="send">إرسال</button>
        </div>
      </section>
    </main>
    <script>
      const convEl = document.getElementById('conversations');
      const msgsEl = document.getElementById('messages');
      const compose = document.getElementById('compose');
      const sendBtn = document.getElementById('send');

      function renderConversations() {
        const list = AdminMessaging.state.conversations;
        convEl.innerHTML = '';
        list.forEach((c) => {
          const div = document.createElement('div');
          div.className = 'conv';
          div.textContent = (c.title || (c.is_support ? 'دعم فني' : 'محادثة')) + (c.order_id ? ` | طلب: ${c.order_id}` : '');
          div.onclick = async () => {
            await AdminMessaging.selectConversation(c.id);
            renderMessages();
          };
          convEl.appendChild(div);
        });
      }

      function renderMessages() {
        const list = AdminMessaging.state.messages;
        msgsEl.innerHTML = '';
        list.forEach((m) => {
          const div = document.createElement('div');
          div.className = 'msg';
          div.textContent = (m.body || '') + (m.order_id ? ` | طلب: ${m.order_id}` : '');
          msgsEl.appendChild(div);
        });
        msgsEl.scrollTop = msgsEl.scrollHeight;
      }

      sendBtn.onclick = async () => {
        const body = compose.value.trim();
        if (!body) return;
        await AdminMessaging.sendMessage(body);
        compose.value = '';
        renderMessages();
      };

      (async function init() {
        await AdminMessaging.initRealtime();
        renderConversations();
        setInterval(renderConversations, 1000);
      })();
    </script>
  </body>
  </html>

